# 기본 설정
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecDataDir /tmp/

# 로깅 설정
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsec_audit.log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 3

# 기본 보안 규칙
SecRule REQUEST_HEADERS:Content-Type "text/xml" \
     "id:1000,phase:1,t:none,block"

# 파일 업로드 제한
SecRule FILES_NAMES "\.(?:php|phtml|php3|php4|php5|php7|phar|inc)$" \
     "id:2000,phase:2,t:lowercase,t:none,block,msg:'PHP 파일 업로드 차단'"

# SQL 인젝션 방지
SecRule ARGS "@detectSQLi" \
     "id:3000,phase:2,block,msg:'SQL 인젝션 시도 감지'"

# XSS 방지
SecRule ARGS "@detectXSS" \
     "id:4000,phase:2,block,msg:'XSS 공격 시도 감지'"

# 파일 업로드 크기 제한
SecRequestBodyLimit 10485760
SecRequestBodyNoFilesLimit 1048576

# 허용된 HTTP 메소드
SecRule REQUEST_METHOD "!^(?:GET|POST|OPTIONS)$" \
     "id:5000,phase:1,block,msg:'허용되지 않은 HTTP 메소드'"

# 파일 확장자 제한
SecRule FILES_NAMES "!\.(?:jpg|jpeg|png|gif|webp)$" \
     "id:6000,phase:2,t:lowercase,t:none,block,msg:'허용되지 않은 파일 형식'"

# 응답 본문 검사
SecResponseBodyLimit 1048576

# # API 디렉터리 보호
# SecRule REQUEST_URI "^/api/" \
#     "id:7000,phase:1,t:none,chain"
#     SecRule REQUEST_HEADERS:X-Requested-With "!^XMLHttpRequest$" \
#     "t:none,deny,status:403,msg:'API 요청은 AJAX를 통해서만 가능합니다.'"

# # 관리자 API 보호
# SecRule REQUEST_URI "^/api/admin/" \
#     "id:7001,phase:1,t:none,chain"
#     SecRule &SESSION:admin_logged_in "@eq 0" \
#     "t:none,deny,status:403,msg:'관리자 인증이 필요합니다.'"

# # 관리자 페이지 보호
# SecRule REQUEST_URI "^/api/auth/" \
#     "id:8000,phase:1,t:none,chain"
#     SecRule &SESSION:admin_logged_in "@eq 0" \
#     "t:none,deny,status:403,msg:'관리자 인증이 필요합니다.'"

# # 스크립트 디렉터리 보호
# SecRule REQUEST_URI "^/api/script/" \
#     "id:9000,phase:1,t:none,chain"
#     SecRule REQUEST_HEADERS:X-Requested-With "!^XMLHttpRequest$" \
#     "t:none,deny,status:403,msg:'스크립트 직접 접근이 차단되었습니다.'"

# # 공통 보안 헤더 설정
# SecRule REQUEST_URI "^/(api/admin|api/auth|api/script)/" \
#     "id:10000,phase:3,t:none,pass,\
#     setenv:secure=1,\
#     setHeader:X-Content-Type-Options=nosniff,\
#     setHeader:X-Frame-Options=DENY,\
#     setHeader:X-XSS-Protection=1;mode=block"

# # Linux 명령어 실행 방지
# SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@rx (?:/etc/passwd|/etc/shadow|/proc/self|/proc/\d+|uname|wget|curl|bash|sh|nc|netcat)" \
#     "id:11000,phase:2,t:lowercase,t:urlDecode,deny,status:403,msg:'시스템 명령어 사용 시도가 차단되었습니다.',\
#     logdata:'매칭된 데이터: %{MATCHED_VAR}'"

# # 명령어 인젝션 방지
# SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@rx [\|\;\`\(\)\{\}\$]" \
#     "id:11001,phase:2,t:none,deny,status:403,msg:'명령어 인젝션 시도가 차단되었습니다.',\
#     logdata:'매칭된 데이터: %{MATCHED_VAR}'"

# # 경로 순회 공격 방지
# SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?:\.\.|\/\/)+" \
#     "id:11002,phase:2,t:urlDecode,t:lowercase,deny,status:403,msg:'경로 순회 공격이 차단되었습니다.',\
#     logdata:'매칭된 데이터: %{MATCHED_VAR}'"

# # 민감한 시스템 파일 접근 방지
# SecRule REQUEST_FILENAME "@rx (?:/etc/|/var/|/usr/|/bin/|/sbin/|/dev/|/proc/|/sys/)" \
#     "id:11003,phase:2,t:none,deny,status:403,msg:'시스템 파일 접근이 차단되었습니다.',\
#     logdata:'매칭된 데이터: %{MATCHED_VAR}'"